<!DOCTYPE html>
<html>
<head>
  <title>AyatDetect - MCGP Invention Club</title>
  <link rel="stylesheet" type="text/css" href="static/styles.css">

</head>
<body>
  <h1>AyatDetect</h1>
  <div id="intro">Salaam! Please record a short snippet of Qur'an and get the detected ayat</div>
  <div id="controls">
    <button id="startButton">Start Recording</button>
    <button id="stopButton">Stop Recording</button>
  </div>


  <div id="status">Status: Idle</div>
  <audio id="recordedAudio" controls style="display: none;"></audio>

  <a id="detected_passage" target="_blank" href="#"></a>
  <div id="output"></div>

  <script>
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const status = document.getElementById('status');
    const output = document.getElementById('output');
    const recordedAudio = document.getElementById('recordedAudio');
    const detected_passage = document.getElementById('detected_passage');


    var local_url = "http://ec2-3-92-207-212.compute-1.amazonaws.com:5000"
    var hosted_url = "http://127.0.0.1:5000"

    var server_url = hosted_url
    fetch(`${local_url}/ping-ayat-detect`).then((response) => {
      console.log(response)

      if (response.status === 200) {
        var server_url = local_url
      } 
      console.log(`Using server url: ${server_url}`)
    })            
    .catch((error) => {
      console.log(`Using server url: ${server_url}`)
    });
;
    

    let stream;
    let mediaRecorder;
    let chunks = [];
    var chunkSize = 0;
    let processIntervalId;

    const handleDataAvailable = (event) => {
      chunks.push(event.data);
    };

    const handleStart = () => {
        chunks = [];
        chunkSize = 0;
        output.textContent = '';
        status.textContent = 'Status: Recording...';
        startButton.disabled = true;
        stopButton.disabled = false;
        recordedAudio.style.display = 'none';
        detected_passage.innerHTML = '';
      
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream)
                mediaRecorder.ondataavailable = (blobEvent) => {
                  console.log('got data', blobEvent);
                  var blob = blobEvent.data;
                  chunkSize += blob.size;
                  chunks.push(blob);
                }

                mediaRecorder.onstop = (blobEvent) => {
                  console.log("data available after MediaRecorder.stop() called.");
                  console.log(blobEvent)

                  recordedAudio.style.display = "block"
                  recordedAudio.controls = true;

                  var blob = new Blob(chunks, { type: "audio/wav; codecs=opus" });
                  console.log(chunkSize)

                  const formData = new FormData();
                  formData.append("audio_data", blob);

                  fetch(`${server_url}/transcribe`, {
                    method: "POST",
                    body: formData,
                  })
                  .then(response => response.json())
                  .then(result => {
                      console.log(result);
                      sn1 = result["start"]["surah_name"]
                      sn1_id = result["start"]["surah_id"]
                      sn2 = result["end"]["surah_name"]
                      n1 = result["start"]["ayat_number"]
                      n2 = result["end"]["ayat_number"]
                      output.innerHTML = `
                      <p>Detected String: ${result["string"]}</p>
                      \n\n
                      <p>Start: ${sn1} ${n1} </p>
                      \n
                      <p>End: ${sn2} ${n2} </p>
                      `;
                      status.textContent = 'Status: Idle';
                      

                      if (sn1 != sn2) {
                        detected_passage.innerHTML = `Passage goes between surahs. See output below`
                        detected_passage.setAttribute("href", `#`)
                        detected_passage.setAttribute("target", '')
                      } else {
                        if (n1 == n2) {
                          detected_passage.innerHTML = `Surah ${sn1}, Ayat ${n1}`
                          detected_passage.setAttribute("href", `https://quran.com/${sn1_id}/${n1}`)
                        
                        } else {
                          detected_passage.innerHTML = `Surah ${sn1}, Ayat ${n1} - ${n2}`
                          detected_passage.setAttribute("href", `https://quran.com/${sn1_id}/${n1}-${n2}`)
                        
                        }
                        detected_passage.setAttribute("target", '_blank')
                      }

                  });

                  const audioURL = window.URL.createObjectURL(blob);
                  recordedAudio.src = audioURL;
                  console.log("recorder stopped");
                };
                mediaRecorder.start();

            })
            .catch((error) => {
                console.error(error);
            });
    };

    const handleStop = () => {
        status.textContent = 'Status: Processing...';
        startButton.disabled = false;
        stopButton.disabled = true;
        mediaRecorder.stop()
    };


    startButton.addEventListener('click', () => {
        handleStart();
    });

    stopButton.addEventListener('click', () => {
      handleStop();
    });
  </script>
</body>
</html>
